name: CI - Quality & Security Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 80

jobs:
  # ============================================
  # QUALIDADE E SEGURAN√áA (Shift-Left)
  # ============================================

  lint:
    name: Code Linting (Ruff) and Type Checking (MyPy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Ruff (Linting and Formatting)
        run: |
          # Verifica se o c√≥digo est√° formatado (substitui o black --check)
          poetry run ruff format --check .

          # Verifica erros de l√≥gica, imports n√£o usados, etc.
          poetry run ruff check .


      - name: Run MyPy (Type Checking)
        run: |
          mypy . --ignore-missing-imports --no-strict-optional || exit 1

  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  sast-scan:
    name: SAST - Static Analysis (SonarQube)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Check Quality Gate status
        if: steps.sonarqube-quality-gate-check.outcome == 'failure'
        run: |
          echo "‚ùå Quality Gate failed! Blocking merge."
          exit 1

      - name: Run Bandit (Security Linter)
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll || exit 1


      #- name: Notify Teams - SAST Failed
      #  if: failure()
      #  uses: aliencube/microsoft-teams-actions@v0.8.0
      #  with:
      #    webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
      #    title: 'üö® SAST Scan Failed'
      #    summary: 'Static Analysis Security Testing failed'
      #    text: |
      #      **Repository:** ${{ github.repository }}
      #      **Branch:** ${{ github.ref_name }}
      #      **Author:** ${{ github.actor }}
      #      **Commit:** ${{ github.sha }}
#
      #      The SAST scan detected security issues that must be resolved before merging.

  sca-scan:
    name: SCA - Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: |
          pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit (Dependency Vulnerability Scan)
        run: |
          pip-audit --requirement requirements.txt --desc --format=json --output pip-audit-report.json || exit 1
          pip-audit --requirement requirements.txt --desc --severity high,critical || exit 1

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Check for High/Critical vulnerabilities
        run: |
          echo "SCA scan completed. High/Critical vulnerabilities will fail the pipeline."

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

      #- name: Notify Teams - SCA Failed
      #  if: failure()
      #  uses: aliencube/microsoft-teams-actions@v0.8.0
      #  with:
      #    webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
      #    title: 'üö® SCA Scan Failed'
      #    summary: 'Dependency vulnerability scan detected critical issues'
      #    text: |
      #      **Repository:** ${{ github.repository }}
      #      **Branch:** ${{ github.ref_name }}

      #    Critical or High severity vulnerabilities found in dependencies.
      #    Update dependencies before proceeding.

  # ============================================
  # TESTES AUTOMATIZADOS (TDD)
  # ============================================

  unit-tests:
    name: Unit Tests (TDD) with Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Python unit tests with coverage
        run: |
          pytest tests/unit/ -v \
            --cov=. \
            --cov-report=html \
            --cov-report=json \
            --cov-report=term \
            --cov-report=xml \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            --junitxml=junit.xml \
            --html=pytest-report.html || exit 1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            junit.xml
            pytest-report.html
          retention-days: 30

      - name: Check coverage threshold
        run: |
          echo "‚úÖ Coverage threshold of ${{ env.COVERAGE_THRESHOLD }}% must be met"

      #- name: Notify Teams - Tests Failed
      #  if: failure()
      #  uses: aliencube/microsoft-teams-actions@v0.8.0
      #  with:
      #    webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
      #    title: '‚ùå Unit Tests Failed'
      #    summary: 'Unit tests or coverage threshold failed'
      #    text: |
      #      **Repository:** ${{ github.repository }}
      #      **Branch:** ${{ github.ref_name }}
#
      #      Unit tests failed or coverage is below ${{ env.COVERAGE_THRESHOLD }}%.

  # ============================================
  # RESUMO E VALIDA√á√ÉO FINAL
  # ============================================

  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, sast-scan, sca-scan, unit-tests]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.sast-scan.result }}" != "success" ] || \
             [ "${{ needs.sca-scan.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå One or more CI jobs failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed"

      #- name: Notify Teams - CI Success
      #  if: success()
      #  uses: aliencube/microsoft-teams-actions@v0.8.0
      #  with:
      #    webhook_uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
      #    title: '‚úÖ CI Pipeline Passed'
      #    summary: 'All quality and security checks passed'
      #    text: |
      #      **Repository:** ${{ github.repository }}
      #      **Branch:** ${{ github.ref_name }}
      #      **Commit:** ${{ github.sha }}
      #      **Author:** ${{ github.actor }}
#
      #      ‚úÖ Linting passed (Pylint, Black, Flake8, MyPy)
      #      ‚úÖ SAST scan passed (SonarQube, Bandit)
      #      ‚úÖ SCA scan passed (pip-audit, Snyk)
      #      ‚úÖ Unit tests passed (coverage ‚â• ${{ env.COVERAGE_THRESHOLD }}%)
#
      #      Ready for merge approval.
