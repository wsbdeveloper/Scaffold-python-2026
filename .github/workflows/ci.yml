name: CI - Quality & Security Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 80

jobs:
  # ============================================
  # QUALIDADE E SEGURANÇA (Shift-Left)
  # ============================================

  lint:
    name: Code Linting (Ruff) and Type Checking (MyPy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Ruff (Linting and Formatting)
        run: |
          # Verifica se o código está formatado (substitui o black --check)
          poetry run ruff format --check .

          # Verifica erros de lógica, imports não usados, etc.
          poetry run ruff check .


      - name: Run MyPy (Type Checking)
        run: |
          mypy . --ignore-missing-imports --no-strict-optional || exit 1


  sast-scan:
    name: SAST - Static Analysis (SonarQube)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          projectKey: wsbdeveloper_Scaffold-python-2026
          organization: wsbdeveloper
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  sca-scan:
    name: SCA - Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: |
          pip install --upgrade pip
          pip install pip-audit

      - name: Check SNYK_TOKEN
        id: snyk_check
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "::warning title=Snyk::SNYK_TOKEN não configurado. Scan de vulnerabilidades será ignorado."
            echo "enabled=false" >> $GITHUB_OUTPUT
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk to check for vulnerabilities
        if: steps.snyk_check.outputs.enabled == 'true'
        uses: snyk/actions/python-3.10@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

  # ============================================
  # TESTES AUTOMATIZADOS (TDD)
  # ============================================

  unit-tests:
    name: Unit Tests (TDD) with Coverage
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-html

      - name: Run Python unit tests with coverage
        run: |
          pytest tests/unit/ -v \
            --cov=. \
            --cov-report=html \
            --cov-report=json \
            --cov-report=term \
            --cov-report=xml \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            --junitxml=junit.xml \
            --html=pytest-report.html || exit 1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            junit.xml
            pytest-report.html
          retention-days: 30

      - name: Check coverage threshold
        run: |
          echo "✅ Coverage threshold of ${{ env.COVERAGE_THRESHOLD }}% must be met"
  # ============================================
  # RESUMO E VALIDAÇÃO FINAL
  # ============================================

  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, sast-scan, sca-scan, unit-tests]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.sast-scan.result }}" != "success" ] || \
             [ "${{ needs.sca-scan.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI checks passed"
